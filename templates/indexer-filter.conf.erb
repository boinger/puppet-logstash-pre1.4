
filter {

  # grok:
  # overview:        http://logstash.net/docs/1.2.1/filters/grok
  # regex:           http://www.geocities.jp/kosako3/oniguruma/doc/RE.txt
  # grok test cases: https://github.com/logstash/logstash/blob/v1.2.1/spec/filters/grok.rb
  # black box cases: https://github.com/Icix/ops-tests/blob/master/logstash_spec.rb

  # mind that we're now using our own patterns_dir which is managed by puppet

  if ! [shn] {
    if [host] =~ /[a-zA-Z]+/ {
      mutate {
        add_field => {"shn" => "%{host}"}
      }
      mutate {
        gsub => ["shn", '\..*', '']
      }
    }
  }

  if ! [fqdn] {
    if [host] =~ /\./ {
      if [host] !~ /\d+\.\d+\.\d+\.\d+/ {
        mutate {
          add_field => {"fqdn" => "%{host}"}
        }
      }
    }
  }

  if [type] == "lumberjack" {
    mutate {
      remove_field => ["offset"]
    }
  }

  if [file] == "/var/log/secure" {
    grok {
      match => ["message", "%{SYSLOGTIMESTAMP:syslog_timestamp} %{IPORHOST:syslog_host} %{SYSLOGPROG}: %{GREEDYDATA:message}"]
      overwrite => ["message"]
      remove_field => ["syslog_host"]
    }

    if [program] == "sudo" {
      grep {
        match => [ "message", "COMMAND=/usr/lib64/nagios/plugins/icix/check_svstat.pl" ]
        negate => true
      }
    }

    date {
      match => ["syslog_timestamp",  "MMM  d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601"]
      remove_field => ["syslog_timestamp"]
    }

    if [program] == "sshd" {
      grok {
        match => ["message", "pam_unix\(sshd:session\): session opened for user %{USERNAME:username}"]
        add_tag => ["session_opened"]
      }

      if "_grokparsefailure" in [tags] {
        grok {
          match => ["message", "pam_unix\(sshd:auth\): authentication failure;.* rhost=%{IPORHOST:remote_host}(?:\s+user=%{USERNAME:username})?"]
          add_tag => ["auth_fail"]
        }
      }

      if "_grokparsefailure" in [tags] {
        grok {
          match => ["message", "Invalid user %{USERNAME:username}(?: from %{IPORHOST:remote_host})?"]
          add_tag => ["invalid_user"]
          add_tag => ["auth_fail"]
        }
      }

      mutate {
        remove_tag => [ "_grokparsefailure" ]
      }
    }
  }

  if [file] == "/var/log/messages" {
    grok {
      match => ["message", "%{SYSLOGTIMESTAMP:syslog_timestamp} %{IPORHOST:syslog_host} %{SYSLOGPROG}: %{GREEDYDATA:message}"]
      overwrite => ["message"]
      remove_field => ["syslog_host"]
    }

    if [program] == "dhclient" {
      drop {}
    }

    date {
      match => ["syslog_timestamp",  "MMM  d HH:mm:ss", "MMM dd HH:mm:ss", "ISO8601"]
      remove_field => ["syslog_timestamp"]
    }
  }

  if [type] == "applog" {
    kv {
      field_split => "^"
      value_split => ":"
    }
  }
}
